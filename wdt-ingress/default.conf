server {
    listen      80;
    listen      [::]:80;
    server_name _;

    access_log /dev/stdout;
    error_log /dev/stdout error;

    # Graphql API
    location ~ ^/graphql?(.*) {
      set $upstream_graphql server;

      proxy_pass http://$upstream_graphql:8000/graphql/;
      proxy_set_header      Host $host:$server_port;
      proxy_set_header      X-Forwarded-For $remote_addr;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }

    # Django Admin
    location ~ ^/admin?(.*) {
      set $upstream_admin server;

      proxy_pass http://$upstream_admin:8000/admin/$1$is_args$args;
      proxy_set_header      Host $host:$server_port;
      proxy_set_header      X-Forwarded-For $remote_addr;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }

    # Web app
    location ~ ^/?(.*) {
      set $upstream_webapp customer-webapp;

      proxy_pass http://$upstream_webapp/$1$is_args$args;
      proxy_set_header      Host $host:$server_port;
      proxy_set_header      X-Forwarded-For $remote_addr;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }
}